_z_complete() {
  local cur="${COMP_WORDS[COMP_CWORD]}"
  COMPREPLY=()

  if [[ "$COMP_CWORD" -eq 1 ]]; then
    COMPREPLY=($(compgen -W "attach" -- "$cur"))
    return
  fi

  local subcommand="${COMP_WORDS[1]}"
  if [[ "$subcommand" == "attach" ]]; then
    while IFS=$'\t' read -r path _desc; do
      [[ "$path" == "$cur"* ]] && COMPREPLY+=("$path")
    done < <(z-completions 2>/dev/null)
  fi
}
complete -F _z_complete z
