#!/usr/bin/env bash
set -euo pipefail

z_merge_main() {
  local current_path="${PWD#"$HOME"/}"
  IFS=/ read -ra arg_path_components <<<"$current_path"

  local eng_area="${arg_path_components[0]}"
  local repo="${arg_path_components[2]}"
  local worktree="${arg_path_components[3]}"

  if [[ "${arg_path_components[1]}" != "worktrees" ]]; then
    gum log -t error "not in a worktree directory: $PWD"
    return 1
  fi

  local repo_path="$HOME/$eng_area/repos/$repo"
  local worktree_path="$HOME/$current_path"

  if [[ ! -d "$repo_path" ]]; then
    gum log -t error "repository not found: $repo_path"
    return 1
  fi

  gum log -t info "merging worktree: $worktree"

  if ! git -C "$repo_path" merge --no-ff "$worktree" -m "Merge worktree: $worktree"; then
    gum log -t error "merge failed, not removing worktree"
    return 1
  fi

  gum log -t info "removing worktree: $worktree_path"
  git -C "$repo_path" worktree remove "$worktree_path"

  gum log -t info "detaching from zmx session"
  zmx detach
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  z_merge_main "$@"
fi
